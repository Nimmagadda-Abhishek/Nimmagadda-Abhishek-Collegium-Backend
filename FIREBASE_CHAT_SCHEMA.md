# Firebase Firestore Schema for Chat

This document defines the strictly recommended schema for Firebase Firestore to ensure compatibility with the backend `api/chat` endpoints.

## 1. Collection: `users`
**Purpose:** Stores user profile data for quick access in the frontend during chat listing (e.g., displaying names and avatars without querying the backend SQL/Mongo DB every time).

| Document ID | Field | Type | Description |
| :--- | :--- | :--- | :--- |
| `firebase_uid` | `displayName` | `string` | User's visible name. |
| | `photoURL` | `string` | URL to user's avatar. |
| | `lastOnline` | `timestamp` | (Optional) For presence features. |
| | `isOnline` | `boolean` | (Optional) For online status. |

---

## 2. Collection: `chats` (The "Rooms")
**Purpose:** Metadata for each chat room.
**Document ID:** `uid1_uid2` (Where ids are **Sorted Alphabetically**). This deterministic ID allows the backend to return the Room ID in `/validate` without needing to look it up in Firestore.

| Document ID | Field | Type | Description |
| :--- | :--- | :--- | :--- |
| `uid1_uid2` | `participants` | `array` | Array of strings `[uid1, uid2]`. Used for security rules (querying "array-contains"). |
| | `lastMessage` | `map` | Preview of the last message. |
| | `lastMessage.text` | `string` | "Hey, how are you?" |
| | `lastMessage.senderId`| `string` | UID of sender. |
| | `lastMessage.timestamp`|`timestamp`| Server timestamp of last msg. |
| | `updatedAt` | `timestamp` | Used for sorting chat list. |

---

## 3. Subcollection: `chats/{roomId}/messages`
**Purpose:** Stores the actual messages for a specific room.
**Document ID:** Auto-generated by Firebase.

| Document ID | Field | Type | Description |
| :--- | :--- | :--- | :--- |
| `(auto-generated)`| `senderId` | `string` | Firebase UID of the sender. |
| | `text` | `string` | The message content. |
| | `imageUrl` | `string` | (Optional) If image header. |
| | `timestamp` | `timestamp` | `FieldValue.serverTimestamp()` |
| | `readBy` | `map` | (Optional) `{ "uid1": true }` for read receipts. |

## Important: Deterministic Room ID
The backend `/api/chat/validate` endpoint generates the Room ID using this exact logic:
```javascript
const firebaseUids = [uid1, uid2].sort();
const roomId = firebaseUids.join('_');
```
**You MUST use this same logic in the frontend when creating or accessing a doc in the `chats` collection.**
